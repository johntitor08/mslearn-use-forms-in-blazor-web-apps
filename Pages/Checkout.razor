@page "/checkout"
@using BlazingPizza.Model
@using Microsoft.AspNetCore.Components.Forms
@inject OrderState OrderState
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager
@implements IDisposable

<EditForm EditContext="editContext" OnValidSubmit="PlaceOrder">
    <DataAnnotationsValidator />

    <div class="form-field">
        <label>Name:</label>
        <div>
            <InputText @bind-Value="Address.Name" class="form-control" />
            <ValidationMessage TValue="string" For="@(() => Address.Name)" />
        </div>
    </div>

    <div class="form-field">
        <label>Line 1:</label>
        <div>
            <InputText @bind-Value="Address.Line1" class="form-control" />
            <ValidationMessage TValue="string" For="@(() => Address.Line1)" />
        </div>
    </div>

    <div class="form-field">
        <label>City:</label>
        <div>
            <InputText @bind-Value="Address.City" class="form-control" />
            <ValidationMessage TValue="string" For="@(() => Address.City)" />
        </div>
    </div>

    <div class="form-field">
        <label>Region:</label>
        <div>
            <InputText @bind-Value="Address.Region" class="form-control" />
            <ValidationMessage TValue="string" For="@(() => Address.Region)" />
        </div>
    </div>

    <div class="form-field">
        <label>Postal code:</label>
        <div>
            <InputText @bind-Value="Address.PostalCode" class="form-control" />
            <ValidationMessage TValue="string" For="@(() => Address.PostalCode)" />
        </div>
    </div>

    <!-- Submit butonu -->
    <button type="submit" class="btn btn-warning" disabled="@isError || isSubmitting">
        @if (isSubmitting)
        {
            <span>Submitting...</span>
        }
        else
        {
            <span>Place order</span>
        }
    </button>

    @if (isError && !isSubmitting)
    {
        <div class="alert alert-danger mt-2">
            Please fill in all required fields correctly.
        </div>
    }
</EditForm>

@code {
    [Parameter]
    public Address Address { get; set; }

    Order Order => OrderState.Order;

    bool isError = false;
    bool isSubmitting = false;
    private EditContext editContext;

    protected override void OnInitialized()
    {
        if (Order.DeliveryAddress == null)
        {
            Order.DeliveryAddress = new Address();
        }

        Address = Order.DeliveryAddress;

        editContext = new EditContext(Address);
        editContext.OnFieldChanged += HandleFieldChanged;

        ValidateForm();
    }

    private void HandleFieldChanged(object sender, FieldChangedEventArgs e)
    {
        ValidateForm();
        StateHasChanged();
    }

    private void ValidateForm()
    {
        isError = !editContext.Validate();
    }

    private async Task PlaceOrder()
    {
        // Submit sırasında disable ve loading
        isSubmitting = true;
        StateHasChanged();

        if (editContext.Validate())
        {
            var response = await HttpClient.PostAsJsonAsync(
            NavigationManager.BaseUri + "orders",
            Order
            );
            var newOrderId = await response.Content.ReadFromJsonAsync<int>();

            OrderState.ResetOrder();
            NavigationManager.NavigateTo($"myorders/{newOrderId}");
        }
        else
        {
            isError = true;
        }

        isSubmitting = false;
        StateHasChanged();
    }

    public void Dispose()
    {
        editContext.OnFieldChanged -= HandleFieldChanged;
    }
}